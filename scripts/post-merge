#!/bin/bash
# Post-merge hook: auto-sync beads-metadata branch after merges
#
# Install: ln -sf ../../scripts/post-merge .git/hooks/post-merge

set -e

# Only run on main branch
current_branch=$(git branch --show-current)
if [ "$current_branch" != "main" ]; then
    exit 0
fi

# Check if beads-metadata exists on remote
if ! git ls-remote --exit-code --heads origin beads-metadata >/dev/null 2>&1; then
    exit 0
fi

# Fetch and check if there are new commits
git fetch origin beads-metadata --quiet

local_head=$(git rev-parse HEAD)
remote_metadata=$(git rev-parse origin/beads-metadata)
merge_base=$(git merge-base HEAD origin/beads-metadata 2>/dev/null || echo "")

# If beads-metadata has commits not in main, merge them
if [ -n "$merge_base" ] && [ "$merge_base" != "$remote_metadata" ]; then
    echo "Syncing beads-metadata into main..."
    git merge origin/beads-metadata --no-edit --quiet
    echo "Beads metadata synced."
fi
